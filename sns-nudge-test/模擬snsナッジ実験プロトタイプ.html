<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¨¡æ“¬SNSãƒŠãƒƒã‚¸å®Ÿé¨“ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --muted: #6b7280;
      --primary: #111827;
      --accent: #e53935;
      /* REC èµ¤ */
      --ring: #4b5563;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--primary);
    }

    .container {
      max-width: 760px;
      margin: 24px auto;
      padding: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      box-shadow: 0 4px 18px rgba(0, 0, 0, 0.04);
      overflow: hidden;
    }

    .header {
      padding: 16px 20px;
      border-bottom: 1px solid #eef0f3;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title {
      font-size: 16px;
      font-weight: 700;
    }

    .sub {
      color: var(--muted);
      font-size: 12px;
    }

    .body {
      padding: 20px;
    }

    .row {
      margin-bottom: 16px;
    }

    .topic {
      background: #f0f7ff;
      border: 1px solid #dbeafe;
      color: #1e40af;
      padding: 14px;
      border-radius: 12px;
    }

    .input-wrap {
      position: relative;
      margin-top: 12px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      padding: 14px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      resize: vertical;
      outline: none;
    }

    textarea:focus {
      border-color: #a5b4fc;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }

    .muted {
      color: var(--muted);
      font-size: 12px;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    button {
      appearance: none;
      border: 1px solid #e5e7eb;
      background: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
    }

    button.primary {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    button[disabled] {
      opacity: .5;
      cursor: not-allowed;
    }

    /* ğŸ‘ï¸ ç›®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆæŠ•ç¨¿æ¬„å³ä¸Šã®å¤–æ ï¼‰ */
    .eye-icon {
      position: absolute;
      top: -12px;
      right: -12px;
      font-size: 22px;
      opacity: 0.85;
      animation: blink 3s infinite;
      user-select: none;
    }

    @keyframes blink {

      0%,
      90%,
      100% {
        transform: scale(1);
        opacity: 0.85
      }

      95% {
        transform: scale(0.92);
        opacity: 0.35
      }
    }

    /* ğŸ”´ REC è¡¨ç¤ºï¼ˆç¢ºèªç”»é¢å³ä¸Šï¼‰ */
    .rec {
      position: absolute;
      top: 8px;
      right: 12px;
      color: var(--accent);
      font-weight: 800;
      letter-spacing: .5px;
      animation: recblink 1s infinite;
    }

    @keyframes recblink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: .3
      }
    }

    /* ğŸª é¡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè»½ã„é¡é¢è¡¨ç¾ã€‚ä»Šå›ã¯RECæ¡ä»¶ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«æ§ãˆã‚ï¼‰ */
    .mirror {
      background: linear-gradient(180deg, #fff, #eef2f7);
      border: 1px solid #d1d5db;
      border-radius: 12px;
      padding: 16px;
      filter: brightness(.98);
    }

    .mirror .user {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .mirror .text {
      font-style: italic;
      color: #1f2937;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* â³ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ãƒªãƒ³ã‚° */
    .cooldown {
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .ring {
      width: 20px;
      height: 20px;
      border: 3px solid #cbd5e1;
      border-top-color: var(--ring);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .footer {
      padding: 16px 20px;
      border-top: 1px solid #eef0f3;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notice {
      color: var(--muted);
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ãƒšãƒ¼ã‚¸åˆ‡æ›¿ã®ãŸã‚ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .screen {
      display: none;
      position: relative;
    }

    .screen.active {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="title">æ¨¡æ“¬SNSãƒŠãƒƒã‚¸å®Ÿé¨“</div>
        <div class="sub" id="condLabel">æ¡ä»¶: â€”</div>
      </div>

      <div class="body">
        <!-- æŠ•ç¨¿ç”»é¢ï¼ˆcomposeï¼‰ -->
        <section id="screen-compose" class="screen active">
          <div class="row topic" id="topic">
            <strong>èª²é¡Œ:</strong> æ¬¡ã®è¨˜äº‹ã¸ã®è¿”ä¿¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚å†…å®¹ã¯è‡ªç”±ã§ã™ãŒã€å…¬é–‹ã¯ã•ã‚Œã¾ã›ã‚“ã€‚
          </div>
          <div class="row input-wrap" id="composeWrap">
            <!-- ğŸ‘ï¸ ç›®ã‚¢ã‚¤ã‚³ãƒ³ã¯æ¡ä»¶ã«ã‚ˆã£ã¦æŒ¿å…¥ -->
            <textarea id="ta" placeholder="ã“ã“ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›"></textarea>
          </div>
          <div class="toolbar">
            <div class="muted" id="charCount">0 æ–‡å­—</div>
            <div class="actions">
              <button id="nextBtn" class="primary">æ¬¡ã¸</button>
            </div>
          </div>
        </section>

        <!-- ç¢ºèªç”»é¢ï¼ˆconfirmï¼‰ -->
        <section id="screen-confirm" class="screen">
          <div class="rec" id="recBadge">â— REC</div>
          <div class="row mirror">
            <div class="user" id="userName">ã‚ãªãŸï¼ˆ@participantï¼‰</div>
            <div class="text" id="mirrorText"></div>
          </div>
          <div class="row">
            <div class="muted" id="cooldownArea" style="display:none;">
              <span class="cooldown"><span class="ring"></span>é€ä¿¡æº–å‚™ä¸­â€¦</span>
            </div>
          </div>
          <div class="toolbar">
            <div class="muted">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ã€å¿…è¦ãªã‚‰ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚</div>
            <div class="actions">
              <button id="backBtn">æˆ»ã‚‹</button>
              <button id="sendBtn" class="primary" disabled>é€ä¿¡</button>
            </div>
          </div>
        </section>

        <!-- å®Œäº†ç”»é¢ï¼ˆcompleteï¼‰ -->
        <section id="screen-complete" class="screen">
          <div class="row">
            <h3>é€ä¿¡ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</h3>
            <p class="muted">ã”å”åŠ›ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ç¶šã‘ã¦äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã«ãŠç­”ãˆãã ã•ã„ï¼ˆåˆ¥ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ã€‚</p>
            <p><a id="surveyLink" href="#" target="_blank">äº‹å¾Œã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚’é–‹ã</a></p>
            <pre id="debugOut"
              style="white-space:pre-wrap; background:#0b1220; color:#cbd5e1; padding:12px; border-radius:10px; font-size:12px; overflow:auto;"></pre>
          </div>
        </section>
      </div>

      <div class="footer">
        <div class="notice">ğŸ”’ æœ¬å®Ÿé¨“ã®ãƒ‡ãƒ¼ã‚¿ã¯å­¦è¡“ç›®çš„ã§åŒ¿åä¿å­˜ã•ã‚Œã¾ã™ã€‚</div>
        <div class="muted" id="pid">â€”</div>
      </div>
    </div>
  </div>

  <script>
    // ====== æ¡ä»¶ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ======
    // cond=CTRL | EYE | REC | REC_MIRROR
    const params = new URLSearchParams(location.search);
    const COND = (params.get('cond') || 'CTRL').toUpperCase();
    const SURVEY_URL = params.get('survey') || '#';

    // ====== å‚åŠ è€…ID ======
    const pid = (() => {
      const k = 'exp_pid';
      let v = sessionStorage.getItem(k);
      if (!v) { v = 'p' + Math.random().toString(36).slice(2, 10); sessionStorage.setItem(k, v); }
      return v;
    })();

    // ====== ãƒ­ã‚°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ ======
    const log = {
      pid,
      cond: COND,
      ua: navigator.userAgent,
      openAt: Date.now(),
      typeStart: null,
      previewOpen: null,
      submitAt: null,
      canceled: false,
      backspaceCount: 0,
      delCount: 0,
      pasteCount: 0,
      deltaChars: 0,
      lenAtSubmit: 0,
    };

    // ====== è¦ç´ å‚ç…§ ======
    const screenCompose = document.getElementById('screen-compose');
    const screenConfirm = document.getElementById('screen-confirm');
    const screenComplete = document.getElementById('screen-complete');
    const condLabel = document.getElementById('condLabel');
    const composeWrap = document.getElementById('composeWrap');
    const ta = document.getElementById('ta');
    const charCount = document.getElementById('charCount');
    const nextBtn = document.getElementById('nextBtn');
    const backBtn = document.getElementById('backBtn');
    const sendBtn = document.getElementById('sendBtn');
    const recBadge = document.getElementById('recBadge');
    const mirrorText = document.getElementById('mirrorText');
    const userName = document.getElementById('userName');
    const cooldownArea = document.getElementById('cooldownArea');
    const pidFoot = document.getElementById('pid');
    const debugOut = document.getElementById('debugOut');
    const surveyLink = document.getElementById('surveyLink');

    // ãƒ©ãƒ™ãƒ«è¡¨ç¤º
    condLabel.textContent = `æ¡ä»¶: ${COND}`;
    pidFoot.textContent = `ID: ${pid}`;
    surveyLink.href = SURVEY_URL;

    // ğŸ‘ï¸ ç›®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆEYEæ¡ä»¶ã§è¿½åŠ ï¼‰
    if (COND === 'EYE' || COND === 'REC_EYE' || COND === 'BOTH') {
      const eye = document.createElement('div');
      eye.className = 'eye-icon';
      eye.textContent = 'ğŸ‘ï¸';
      composeWrap.appendChild(eye);
    }

    // å…¥åŠ›ç›£è¦–ï¼ˆãƒ­ã‚°ï¼‰
    let prevLen = 0;
    ta.addEventListener('input', () => {
      const len = ta.value.length;
      charCount.textContent = `${len} æ–‡å­—`;
      if (log.typeStart === null && len > 0) log.typeStart = Date.now();
      const d = len - prevLen;
      log.deltaChars += d;
      prevLen = len;
    });
    ta.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace') log.backspaceCount++;
      if (e.key === 'Delete') log.delCount++;
      if (e.ctrlKey && e.key.toLowerCase() === 'v') log.pasteCount++;
    });

    // ç”»é¢é·ç§»
    const go = (name) => {
      for (const el of [screenCompose, screenConfirm, screenComplete]) el.classList.remove('active');
      if (name === 'compose') screenCompose.classList.add('active');
      if (name === 'confirm') screenConfirm.classList.add('active');
      if (name === 'complete') screenComplete.classList.add('active');
    };

    // æ¬¡ã¸ï¼ˆç¢ºèªç”»é¢ï¼‰
    nextBtn.addEventListener('click', () => {
      mirrorText.textContent = ta.value.trim();
      if (!mirrorText.textContent) { ta.focus(); return; }

      // RECãƒãƒƒã‚¸è¡¨ç¤ºï¼ˆRECç³»æ¡ä»¶ã®ã¿ï¼‰
      const showREC = (COND === 'REC' || COND === 'REC_MIRROR');
      recBadge.style.display = showREC ? 'block' : 'none';

      // é¡UIï¼šä»Šå›ã¯å¸¸ã«ä½¿ç”¨å¯ï¼ˆè¦–è¦šçš„ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã ãŒã€RECã®ã¿ã®æ¡ä»¶ã§ã¯æ·¡è‰²åŒ–ã—ãŸã„å ´åˆã¯ã“ã“ã§èª¿æ•´å¯èƒ½
      // ï¼ˆå¿…è¦ãªã‚‰ cond ã«å¿œã˜ã¦ .mirror ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ï¼‰

      go('confirm');
      log.previewOpen = Date.now();

      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆé€ä¿¡ãƒœã‚¿ãƒ³ç„¡åŠ¹ â†’ 1.5ç§’å¾Œã«æœ‰åŠ¹ï¼‰
      cooldownArea.style.display = 'inline-block';
      sendBtn.disabled = true;
      setTimeout(() => { sendBtn.disabled = false; cooldownArea.style.display = 'none'; }, 1500);
    });

    // æˆ»ã‚‹
    backBtn.addEventListener('click', () => {
      go('compose');
      log.canceled = true; // æˆ»ã£ã¦ä¿®æ­£ã—ãŸäº‹å®Ÿã‚’è¨˜éŒ²
      ta.focus();
    });

    // é€ä¿¡
    sendBtn.addEventListener('click', async () => {
      log.submitAt = Date.now();
      log.lenAtSubmit = ta.value.length;

      // GASå´TOKENã¨ä¸€è‡´ã•ã›ã‚‹
      const payload = { ...log, text: ta.value, token: 'NUDGE_2025_SECRET' };

      // ç”»é¢ã®ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºï¼ˆä»»æ„ï¼‰
      debugOut.textContent = JSON.stringify(payload, null, 2);

      // â˜… ã‚ãªãŸã®ãƒ‡ãƒ—ãƒ­ã‚¤URL
      const WEBHOOK_URL = 'https://script.google.com/a/macros/s.iwate-pu.ac.jp/s/AKfycbxpSAOe4WvOj5KtUimJ-zVuyFn4CNz8266DwrO5SMtTdRgLhyklsUlHt5VIy87OPXJ4SQ/exec';

      try {
        await fetch(WEBHOOK_URL, {
          method: 'POST',
          mode: 'no-cors',                         // CORSå›é¿ï¼ˆå¿œç­”ã¯èª­ã¾ãªã„ï¼‰
          headers: { 'Content-Type': 'text/plain' }, // preflightå›é¿
          body: JSON.stringify(payload)
        });
      } catch (e) {
        console.error('POST failed', e);
      }

      go('complete');
    });


    // ãƒˆãƒ”ãƒƒã‚¯ï¼ˆå®Ÿé¨“ç”¨ã®ç°¡æ˜“ãƒ€ãƒŸãƒ¼ï¼‰
    document.getElementById('topic').innerHTML = `
      <strong>èª²é¡Œ:</strong> ä»¥ä¸‹ã®è¨˜äº‹ã«å¯¾ã—ã¦ã€ã‚ãªãŸã®æ„è¦‹ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ã€‚<br/>
      <em>ä¾‹: å­¦å†…ã®æ–½è¨­åˆ©ç”¨ãƒ«ãƒ¼ãƒ«ãŒå¤‰æ›´ã•ã‚Œã€ä¸€éƒ¨ã®å­¦ç”Ÿã‹ã‚‰ä¸æº€ã®å£°ãŒå‡ºã¦ã„ã‚‹ã¨ã„ã†ãƒ‹ãƒ¥ãƒ¼ã‚¹ã€‚</em>
    `;
  </script>
</body>

</html>